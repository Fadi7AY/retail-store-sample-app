name: Build, Push, and Deploy (GitOps)

on:
  push:
    branches:
      - main

permissions:
  contents: read # Only read permissions needed for the app repo

jobs:
  # JOB 1: Detect which services changed in the src/ directory
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # This outputs a JSON array of changed services (e.g., '["ui", "cart"]')
      matrix: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Path Filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          # Define filters to map paths to service names
          filters: |
            ui: 'src/ui/**'
            catalog: 'src/catalog/**'
            cart: 'src/cart/**'
            orders: 'src/orders/**'
            checkout: 'src/checkout/**'

  # JOB 2: Build and Push ONLY changed services in PARALLEL
  build-and-push:
    needs: detect-changes
    # Skip this job if no services changed
    if: ${{ needs.detect-changes.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Parse the JSON array from Job 1 to create parallel jobs
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # Builds only the specific service for this matrix run
      - name: Build and Push ${{ matrix.service }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPO_NAME: retail-store-${{ matrix.service }}
        run: |
          echo "Building ${{ matrix.service }}..."
          docker build -t $ECR_REGISTRY/$REPO_NAME:$TAG ./src/${{ matrix.service }}
          docker push $ECR_REGISTRY/$REPO_NAME:$TAG
          echo "::notice::Successfully pushed $REPO_NAME:$TAG"

  #  Update the GitOps Repo
  update-manifests:
    needs: [detect-changes, build-and-push]
    if: ${{ needs.detect-changes.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          repository: Fadi7AY/retail-store-gitops
          token: ${{ secrets.GITOPS_PAT }}
          path: gitops-repo

      - name: Update Helm Values
        env:
          CHANGED_SERVICES: ${{ needs.detect-changes.outputs.matrix }}
          TAG: ${{ github.sha }} 
        run: |
          SHORT_TAG=${TAG::7}
          cd gitops-repo
          
          # Iterate ONLY through the services that actually changed/built
          echo $CHANGED_SERVICES | jq -r '.[]' | while read service; do
            echo "Updating tag for $service to $SHORT_TAG"
            
            # Update the specific values.yaml for the changed service
            sed -i "s/tag: \".*\"/tag: \"$SHORT_TAG\"/" apps/$service/values.yaml
          done
          
          echo "Changes applied to GitOps repo:"
          git diff

      - name: Commit and Push to GitOps Repo
        run: |
          cd gitops-repo
          git config user.name "GitHub Actions CI"
          git config user.email "actions@github.com"
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "CI: Update image tags for services: ${{ needs.detect-changes.outputs.matrix }} to ${GITHUB_SHA::7}"
            git push origin main
          else
            echo "No changes detected."
          fi